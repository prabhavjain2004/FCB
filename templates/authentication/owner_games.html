{% extends 'authentication/owner_base.html' %}
{% load static %}

{% block title %}Games & Stations{% endblock %}
{% block page_title %}Games & Stations{% endblock %}
{% block page_subtitle %}Manage gaming resources and equipment{% endblock %}

{% block header_actions %}
<button id="refreshBtn" class="flex w-9 h-9 sm:w-10 sm:h-10 rounded-full bg-indigo-600 hover:bg-indigo-700 items-center justify-center text-white transition-all flex-shrink-0">
    <i class="bi bi-arrow-clockwise text-sm"></i>
</button>
{% endblock %}

{% block extra_css %}
<style>
    /* Ensure refresh button matches profile badge exactly */
    #refreshBtn {
        width: 2.25rem !important;
        height: 2.25rem !important;
        min-width: 2.25rem !important;
        min-height: 2.25rem !important;
        padding: 0 !important;
        border: none !important;
    }
    
    @media (min-width: 640px) {
        #refreshBtn {
            width: 2.5rem !important;
            height: 2.5rem !important;
            min-width: 2.5rem !important;
            min-height: 2.5rem !important;
        }
    }
    
    .hero-bg {
        position: absolute;
        inset: 0;
        overflow: hidden;
        z-index: 0;
        pointer-events: none;
        height: 100%;
    }
    
    .gradient-orb {
        position: absolute;
        border-radius: 50%;
        filter: blur(100px);
        opacity: 0.2;
        animation: floatOrb 20s ease-in-out infinite;
    }
    
    .orb-1 {
        width: 400px;
        height: 400px;
        background: radial-gradient(circle, rgba(102, 126, 234, 0.4) 0%, transparent 70%);
        top: -100px;
        right: -100px;
    }
    
    .orb-2 {
        width: 350px;
        height: 350px;
        background: radial-gradient(circle, rgba(168, 85, 247, 0.3) 0%, transparent 70%);
        bottom: -80px;
        left: -80px;
        animation-delay: 7s;
    }
    
    @keyframes floatOrb {
        0%, 100% { transform: translate(0, 0) scale(1); }
        33% { transform: translate(20px, -20px) scale(1.05); }
        66% { transform: translate(-20px, 20px) scale(0.95); }
    }
    
    .grid-pattern {
        background-image: 
            linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
        background-size: 50px 50px;
        position: absolute;
        inset: 0;
        z-index: 0;
    }
    
    .game-card {
        background: rgba(30, 41, 59, 0.5);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 1.5rem;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .game-card:hover {
        transform: translateY(-4px);
        border-color: rgba(102, 126, 234, 0.5);
    }
    
    @media (max-width: 768px) {
        .orb-1, .orb-2 {
            width: 250px;
            height: 250px;
            filter: blur(60px);
        }
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="relative">
    <!-- Background Elements -->
    <div class="hero-bg">
        <div class="gradient-orb orb-1"></div>
        <div class="gradient-orb orb-2"></div>
        <div class="grid-pattern"></div>
    </div>
    
    <!-- Debug Info (can be removed in production) -->
    <div class="mb-4 relative z-10 text-xs text-gray-500">
        <span>üïê IST Time: {{ now|date:"d M Y, h:i A" }}</span>
        <span class="ml-4">üìÖ Today: {{ today }}</span>
    </div>
    
    <!-- Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 relative z-10">
        <div class="stat-card animate-fade-in-up" style="animation-delay: 0.1s;">
            <div class="flex items-center justify-between mb-3">
                <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                    <i class="bi bi-controller text-white text-xl"></i>
                </div>
            </div>
            <p class="text-gray-400 text-xs mb-1 font-medium">Total Games</p>
            <h3 class="text-white text-2xl sm:text-3xl font-black" style="font-family: 'Orbitron', sans-serif;">{{ total_games }}</h3>
        </div>

        <div class="stat-card animate-fade-in-up" style="animation-delay: 0.2s;">
            <div class="flex items-center justify-between mb-3">
                <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: linear-gradient(135deg, #10b981, #059669);">
                    <i class="bi bi-check-circle text-white text-xl"></i>
                </div>
            </div>
            <p class="text-gray-400 text-xs mb-1 font-medium">Active</p>
            <h3 class="text-white text-2xl sm:text-3xl font-black" style="font-family: 'Orbitron', sans-serif;">{{ active_games_count }}</h3>
        </div>

        <div class="stat-card animate-fade-in-up" style="animation-delay: 0.3s;">
            <div class="flex items-center justify-between mb-3">
                <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                    <i class="bi bi-wrench text-white text-xl"></i>
                </div>
            </div>
            <p class="text-gray-400 text-xs mb-1 font-medium">Maintenance</p>
            <h3 class="text-white text-2xl sm:text-3xl font-black" style="font-family: 'Orbitron', sans-serif;">{{ inactive_games_count }}</h3>
        </div>

        <div class="stat-card animate-fade-in-up" style="animation-delay: 0.4s;">
            <div class="flex items-center justify-between mb-3">
                <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: linear-gradient(135deg, #a855f7, #9333ea);">
                    <i class="bi bi-star text-white text-xl"></i>
                </div>
            </div>
            <p class="text-gray-400 text-xs mb-1 font-medium">Most Popular</p>
            <h3 class="text-white text-sm font-bold truncate">{{ most_popular_game.game__name|default:"N/A" }}</h3>
            <p class="text-xs text-gray-500">{{ most_popular_game.count|default:0 }} today</p>
        </div>
    </div>

    <!-- Add Game Button & Quick Actions -->
    <div class="mb-6 relative z-10 animate-fade-in-up flex flex-wrap gap-3" style="animation-delay: 0.5s;">
        <a href="{% url 'booking:game_management:game_create' %}" class="btn btn-primary inline-flex items-center gap-2">
            <i class="bi bi-plus-circle"></i>
            <span>Add New Game</span>
        </a>
        <a href="{% url 'booking:game_management:dashboard' %}" class="btn btn-secondary inline-flex items-center gap-2">
            <i class="bi bi-speedometer2"></i>
            <span>Game Management Dashboard</span>
        </a>
        <a href="{% url 'booking:game_management:schedule_management' %}" class="btn btn-secondary inline-flex items-center gap-2">
            <i class="bi bi-calendar3"></i>
            <span>Schedule Management</span>
        </a>
    </div>

    <!-- Games Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8 relative z-10">
        {% for game in games %}
        <div class="game-card animate-fade-in-up" style="animation-delay: 0.{{ forloop.counter }}s;">
            <!-- Game Image -->
            <div class="h-48 bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center relative">
                {% if game.image %}
                <img src="{{ game.image.url }}" alt="{{ game.name }}" class="w-full h-full object-cover">
                {% else %}
                <i class="bi bi-controller text-white text-6xl"></i>
                {% endif %}
                
                <!-- Status Badge -->
                <div class="absolute top-4 right-4">
                    {% if game.is_active %}
                    <span class="px-3 py-1 bg-green-500 text-white text-xs font-bold rounded-full">Active</span>
                    {% else %}
                    <span class="px-3 py-1 bg-yellow-500 text-white text-xs font-bold rounded-full">Maintenance</span>
                    {% endif %}
                </div>

                <!-- Occupied Badge -->
                {% if game.is_occupied %}
                <div class="absolute top-4 left-4">
                    <span class="px-3 py-1 bg-red-500 text-white text-xs font-bold rounded-full flex items-center gap-1">
                        <i class="bi bi-circle-fill animate-pulse"></i> Occupied
                    </span>
                </div>
                {% endif %}
            </div>

            <!-- Game Details -->
            <div class="p-6">
                <h3 class="text-xl font-black text-white mb-2">{{ game.name }}</h3>
                <p class="text-sm text-gray-400 mb-4 line-clamp-2">{{ game.description|truncatewords:15 }}</p>

                <!-- Game Info -->
                <div class="space-y-2 mb-4">
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-gray-400">Capacity:</span>
                        <span class="font-semibold text-white">{{ game.capacity }} player(s)</span>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-gray-400">Type:</span>
                        <span class="font-semibold text-white">{{ game.get_booking_type_display }}</span>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-gray-400">Private Price:</span>
                        <span class="font-semibold text-green-400">‚Çπ{{ game.private_price }}</span>
                    </div>
                    {% if game.shared_price %}
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-gray-400">Shared Price:</span>
                        <span class="font-semibold text-blue-400">‚Çπ{{ game.shared_price }}</span>
                    </div>
                    {% endif %}
                </div>

                <!-- Today's Stats -->
                <div class="grid grid-cols-2 gap-4 mb-4 p-3 rounded-lg" style="background: rgba(255, 255, 255, 0.05);">
                    <div class="text-center">
                        <p class="text-xs text-gray-400">Today's Bookings</p>
                        <p class="text-lg font-black text-indigo-400">{{ game.todays_bookings }}</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-400">Today's Revenue</p>
                        <p class="text-lg font-black text-green-400">‚Çπ{{ game.todays_revenue|floatformat:0 }}</p>
                    </div>
                </div>

                <!-- Schedule Info -->
                <div class="mb-4 p-3 rounded-lg" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3);">
                    <p class="text-xs text-gray-400 mb-1">Schedule</p>
                    <p class="text-sm font-bold text-white">
                        {{ game.opening_time|date:"h:i A" }} - {{ game.closing_time|date:"h:i A" }}
                    </p>
                    <p class="text-xs text-gray-400 mt-1">{{ game.slot_duration_minutes }} min slots</p>
                </div>

                <!-- Actions -->
                <div class="flex gap-2">
                    <a href="{% url 'booking:game_management:game_update' game.id %}" class="flex-1 text-center px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="bi bi-pencil"></i> Edit
                    </a>
                    <button onclick="toggleGameStatus('{{ game.id }}', {% if game.is_active %}true{% else %}false{% endif %})" 
                            class="flex-1 text-center px-4 py-2 {% if game.is_active %}bg-yellow-600 hover:bg-yellow-700{% else %}bg-green-600 hover:bg-green-700{% endif %} text-white text-sm font-semibold rounded-lg transition-colors">
                        <i class="bi bi-{% if game.is_active %}wrench{% else %}check{% endif %}"></i> 
                        {% if game.is_active %}Maintenance{% else %}Activate{% endif %}
                    </button>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-span-full text-center py-12 owner-card">
            <i class="bi bi-controller text-gray-600 text-6xl mb-4"></i>
            <p class="text-gray-400 mb-4">No games available yet</p>
            <a href="{% url 'booking:game_management:game_create' %}" class="btn btn-primary inline-flex items-center gap-2">
                <i class="bi bi-plus-circle"></i>
                <span>Add Your First Game</span>
            </a>
        </div>
        {% endfor %}
    </div>

    <!-- Station Status Board -->
    <div class="owner-card relative z-10 animate-fade-in-up" style="animation-delay: 0.9s;">
        <h3 class="text-xl font-bold text-white mb-6">Real-Time Station Status</h3>
        
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
            {% for game in games %}
            <div class="p-4 border-2 rounded-lg text-center transition-all
                {% if not game.is_active %}border-yellow-500/50 bg-yellow-500/10
                {% elif game.is_occupied %}border-red-500/50 bg-red-500/10
                {% else %}border-green-500/50 bg-green-500/10{% endif %}">
                <div class="w-12 h-12 mx-auto mb-2 rounded-full flex items-center justify-center
                    {% if not game.is_active %}bg-yellow-500/20
                    {% elif game.is_occupied %}bg-red-500/20
                    {% else %}bg-green-500/20{% endif %}">
                    <i class="bi bi-controller
                        {% if not game.is_active %}text-yellow-400
                        {% elif game.is_occupied %}text-red-400
                        {% else %}text-green-400{% endif %}"></i>
                </div>
                <p class="text-sm font-bold text-white truncate">{{ game.name }}</p>
                <p class="text-xs mt-1
                    {% if not game.is_active %}text-yellow-400
                    {% elif game.is_occupied %}text-red-400
                    {% else %}text-green-400{% endif %}">
                    {% if not game.is_active %}
                        Maintenance
                    {% elif game.is_occupied %}
                        Occupied
                    {% else %}
                        Available
                    {% endif %}
                </p>
            </div>
            {% endfor %}
        </div>

        <!-- Legend -->
        <div class="flex flex-wrap gap-4 mt-6 pt-6 border-t border-white/10">
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-green-500/20 border-2 border-green-500/50 rounded"></div>
                <span class="text-sm text-gray-400">Available</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-red-500/20 border-2 border-red-500/50 rounded"></div>
                <span class="text-sm text-gray-400">Occupied</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-yellow-500/20 border-2 border-yellow-500/50 rounded"></div>
                <span class="text-sm text-gray-400">Maintenance</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .pulse-update {
        animation: pulseGlow 0.5s ease-in-out;
    }
    
    @keyframes pulseGlow {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; transform: scale(1.02); }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Helper function to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Toggle game status function
    window.toggleGameStatus = function(gameId, isActive) {
        const action = isActive ? 'maintenance' : 'activate';
        const message = isActive ? 
            'Mark this game as under maintenance? It will be unavailable for bookings.' :
            'Activate this game? It will be available for bookings.';
        
        if (confirm(message)) {
            // Get CSRF token
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                             getCookie('csrftoken');
            
            console.log('Toggling game status:', gameId, 'Current:', isActive, 'CSRF:', csrftoken);
            
            // Make AJAX request to toggle status
            const url = `/booking/games/manage/${gameId}/toggle-status/`;
            console.log('Request URL:', url);
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    is_active: !isActive
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in-up';
                    successMsg.innerHTML = `<i class="bi bi-check-circle mr-2"></i>${data.message}`;
                    document.body.appendChild(successMsg);
                    
                    // Remove message after 3 seconds
                    setTimeout(() => {
                        successMsg.remove();
                    }, 3000);
                    
                    // Reload page to show updated status
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    console.error('Toggle failed:', data.error);
                    alert('Error: ' + (data.error || 'Failed to update game status'));
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert('Failed to update game status. Error: ' + error.message);
            });
        }
    };
    
    // Refresh button functionality
    const refreshButton = document.getElementById('refreshBtn');
    if (refreshButton) {
        refreshButton.onclick = function() {
            const icon = this.querySelector('i');
            icon.style.animation = 'spin 1s linear infinite';
            
            // Reload page
            setTimeout(() => {
                window.location.reload();
            }, 500);
        };
    }
    
    // Auto-refresh every 30 seconds for real-time updates
    let autoRefreshInterval = setInterval(function() {
        // Only refresh if user is not interacting and page is visible
        if (!document.hidden) {
            console.log('Auto-refreshing games page at ' + new Date().toLocaleTimeString());
            window.location.reload();
        }
    }, 30000);
    
    // Refresh when page becomes visible again
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            window.location.reload();
        }
    });
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
    });
});
</script>
{% endblock %}
