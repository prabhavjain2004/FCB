{% extends 'authentication/owner_base.html' %}
{% load static %}

{% block title %}Reports & Analytics{% endblock %}
{% block page_title %}Reports & Analytics{% endblock %}
{% block page_subtitle %}Deep insights and business intelligence{% endblock %}

{% block extra_css %}
<style>
    /* Fix infinite scroll - prevent background from extending page */
    .reports-content-wrapper {
        position: relative;
        contain: layout style paint;
        isolation: isolate;
        min-height: auto;
    }
    
    .hero-bg {
        position: fixed;
        top: 4rem;
        left: 0;
        right: 0;
        height: 100vh;
        overflow: hidden;
        z-index: -1;
        pointer-events: none;
        contain: strict;
    }
    
    .gradient-orb {
        position: absolute;
        border-radius: 50%;
        filter: blur(100px);
        opacity: 0.15;
        /* REMOVED ANIMATION - this was causing infinite scroll */
        will-change: auto;
        transform: translateZ(0);
        backface-visibility: hidden;
    }
    
    .orb-1 {
        width: 400px;
        height: 400px;
        background: radial-gradient(circle, rgba(102, 126, 234, 0.4) 0%, transparent 70%);
        top: 10%;
        right: 10%;
    }
    
    .orb-2 {
        width: 350px;
        height: 350px;
        background: radial-gradient(circle, rgba(168, 85, 247, 0.3) 0%, transparent 70%);
        bottom: 10%;
        left: 10%;
    }
    
    .grid-pattern {
        background-image: 
            linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
        background-size: 50px 50px;
        position: absolute;
        inset: 0;
        z-index: 0;
    }
    
    @media (max-width: 768px) {
        .orb-1, .orb-2 {
            width: 250px;
            height: 250px;
            filter: blur(60px);
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Background Elements (Fixed Position) -->
<div class="hero-bg">
    <div class="gradient-orb orb-1"></div>
    <div class="gradient-orb orb-2"></div>
    <div class="grid-pattern"></div>
</div>

<div class="reports-content-wrapper">
    <!-- Date Range Filter -->
    <div class="owner-card mb-6 relative z-10 animate-fade-in-up">
        <form method="get" class="flex flex-col sm:flex-row items-end gap-4">
            <div class="flex-1 w-full">
                <label class="block text-sm font-medium text-gray-300 mb-2">Analysis Period</label>
                <select name="days" class="w-full px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="7" {% if days == 7 %}selected{% endif %}>Last 7 Days</option>
                    <option value="30" {% if days == 30 %}selected{% endif %}>Last 30 Days</option>
                    <option value="90" {% if days == 90 %}selected{% endif %}>Last 90 Days</option>
                    <option value="180" {% if days == 180 %}selected{% endif %}>Last 6 Months</option>
                    <option value="365" {% if days == 365 %}selected{% endif %}>Last Year</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary w-full sm:w-auto">
                <i class="bi bi-bar-chart"></i> Generate Report
            </button>
            <button type="button" onclick="exportReport()" class="btn btn-secondary w-full sm:w-auto">
                <i class="bi bi-download"></i> Export
            </button>
        </form>
        <p class="text-sm text-gray-400 mt-3">
            Analyzing data from {{ start_date|date:"M d, Y" }} to {{ end_date|date:"M d, Y" }}
        </p>
    </div>

    <!-- Key Metrics -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 relative z-10">
        <div class="stat-card animate-fade-in-up" style="animation-delay: 0.1s;">
            <div class="flex items-center justify-between mb-3">
                <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                    <i class="bi bi-calendar-check text-white text-xl"></i>
                </div>
            </div>
            <p class="text-gray-400 text-xs mb-1 font-medium">Total Bookings</p>
            <h3 class="text-white text-2xl sm:text-3xl font-black" style="font-family: 'Orbitron', sans-serif;">{{ total_bookings }}</h3>
        </div>

        <div class="stat-card animate-fade-in-up" style="animation-delay: 0.2s;">
            <div class="flex items-center justify-between mb-3">
                <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: linear-gradient(135deg, #10b981, #059669);">
                    <i class="bi bi-currency-rupee text-white text-xl"></i>
                </div>
            </div>
            <p class="text-gray-400 text-xs mb-1 font-medium">Avg Booking Value</p>
            <h3 class="text-white text-2xl sm:text-3xl font-black" style="font-family: 'Orbitron', sans-serif;">₹{{ avg_booking_value|floatformat:0 }}</h3>
        </div>

        <div class="stat-card animate-fade-in-up" style="animation-delay: 0.3s;">
            <div class="flex items-center justify-between mb-3">
                <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                    <i class="bi bi-x-circle text-white text-xl"></i>
                </div>
            </div>
            <p class="text-gray-400 text-xs mb-1 font-medium">Cancellation Rate</p>
            <h3 class="text-white text-2xl sm:text-3xl font-black" style="font-family: 'Orbitron', sans-serif;">{{ cancellation_rate|floatformat:1 }}%</h3>
        </div>

        <div class="stat-card animate-fade-in-up" style="animation-delay: 0.4s;">
            <div class="flex items-center justify-between mb-3">
                <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: linear-gradient(135deg, #a855f7, #9333ea);">
                    <i class="bi bi-pie-chart text-white text-xl"></i>
                </div>
            </div>
            <p class="text-gray-400 text-xs mb-1 font-medium">Utilization Rate</p>
            <h3 class="text-white text-2xl sm:text-3xl font-black" style="font-family: 'Orbitron', sans-serif;">{{ utilization_rate|floatformat:1 }}%</h3>
        </div>
    </div>

    <!-- Revenue Comparison -->
    <div class="owner-card mb-8 relative z-10 animate-fade-in-up" style="animation-delay: 0.5s;">
        <h3 class="text-xl font-bold text-white mb-6">Revenue Comparison</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="text-center p-4 rounded-lg" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3);">
                <p class="text-sm text-gray-400 mb-2">Current Period</p>
                <p class="text-3xl font-black text-green-400">₹{{ current_revenue|floatformat:2 }}</p>
            </div>
            <div class="text-center p-4 rounded-lg" style="background: rgba(107, 114, 128, 0.1); border: 1px solid rgba(107, 114, 128, 0.3);">
                <p class="text-sm text-gray-400 mb-2">Previous Period</p>
                <p class="text-3xl font-black text-gray-400">₹{{ previous_revenue|floatformat:2 }}</p>
            </div>
            <div class="text-center p-4 rounded-lg" style="background: {% if revenue_change >= 0 %}rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3){% else %}rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3){% endif %};">
                <p class="text-sm text-gray-400 mb-2">Change</p>
                <p class="text-3xl font-black {% if revenue_change >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                    <i class="bi bi-arrow-{% if revenue_change >= 0 %}up{% else %}down{% endif %}"></i>
                    {{ revenue_change|floatformat:1 }}%
                </p>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8 relative z-10">
        <div class="owner-card animate-fade-in-up" style="animation-delay: 0.6s;">
            <h3 class="text-xl font-bold text-white mb-6">Booking Trend</h3>
            <div style="position: relative; height: 300px; width: 100%;">
                <canvas id="bookingTrendChart"></canvas>
            </div>
        </div>

        <div class="owner-card animate-fade-in-up" style="animation-delay: 0.7s;">
            <h3 class="text-xl font-bold text-white mb-6">Peak Hours Analysis</h3>
            <div style="position: relative; height: 300px; width: 100%;">
                <canvas id="peakHoursChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Customer Analytics -->
    <div class="owner-card mb-8 relative z-10 animate-fade-in-up" style="animation-delay: 0.8s;">
        <h3 class="text-xl font-bold text-white mb-6">Customer Analytics</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="text-center p-4 rounded-lg" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.1)); border: 1px solid rgba(59, 130, 246, 0.3);">
                <i class="bi bi-people text-3xl text-blue-400 mb-2"></i>
                <p class="text-2xl font-black text-white">{{ total_customers }}</p>
                <p class="text-sm text-gray-400 mt-1">Total Customers</p>
            </div>
            <div class="text-center p-4 rounded-lg" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); border: 1px solid rgba(16, 185, 129, 0.3);">
                <i class="bi bi-person-plus text-3xl text-green-400 mb-2"></i>
                <p class="text-2xl font-black text-white">{{ new_customers }}</p>
                <p class="text-sm text-gray-400 mt-1">New Customers</p>
            </div>
            <div class="text-center p-4 rounded-lg" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(147, 51, 234, 0.1)); border: 1px solid rgba(168, 85, 247, 0.3);">
                <i class="bi bi-cash-stack text-3xl text-purple-400 mb-2"></i>
                <p class="text-2xl font-black text-white">₹{{ customer_ltv|floatformat:0 }}</p>
                <p class="text-sm text-gray-400 mt-1">Avg Customer LTV</p>
            </div>
            <div class="text-center p-4 rounded-lg" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1)); border: 1px solid rgba(245, 158, 11, 0.3);">
                <i class="bi bi-graph-up text-3xl text-yellow-400 mb-2"></i>
                <p class="text-2xl font-black text-white">85%</p>
                <p class="text-sm text-gray-400 mt-1">Retention Rate</p>
            </div>
        </div>
    </div>

    <!-- Pre-built Reports -->
    <div class="owner-card relative z-10 animate-fade-in-up" style="animation-delay: 0.9s;">
        <h3 class="text-xl font-bold text-white mb-6">Pre-built Reports</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <button onclick="generateReport('daily')" class="p-4 border-2 border-white/10 rounded-lg hover:border-indigo-500/50 hover:bg-white/5 transition-all text-left">
                <i class="bi bi-calendar-day text-indigo-400 text-2xl mb-2"></i>
                <h4 class="font-bold text-white">Daily Summary</h4>
                <p class="text-sm text-gray-400 mt-1">Today's complete activity report</p>
            </button>

            <button onclick="generateReport('weekly')" class="p-4 border-2 border-white/10 rounded-lg hover:border-green-500/50 hover:bg-white/5 transition-all text-left">
                <i class="bi bi-calendar-week text-green-400 text-2xl mb-2"></i>
                <h4 class="font-bold text-white">Weekly Report</h4>
                <p class="text-sm text-gray-400 mt-1">This week's performance metrics</p>
            </button>

            <button onclick="generateReport('monthly')" class="p-4 border-2 border-white/10 rounded-lg hover:border-purple-500/50 hover:bg-white/5 transition-all text-left">
                <i class="bi bi-calendar text-purple-400 text-2xl mb-2"></i>
                <h4 class="font-bold text-white">Monthly Report</h4>
                <p class="text-sm text-gray-400 mt-1">Full month analysis and insights</p>
            </button>

            <button onclick="generateReport('revenue')" class="p-4 border-2 border-white/10 rounded-lg hover:border-yellow-500/50 hover:bg-white/5 transition-all text-left">
                <i class="bi bi-currency-rupee text-yellow-400 text-2xl mb-2"></i>
                <h4 class="font-bold text-white">Revenue Analysis</h4>
                <p class="text-sm text-gray-400 mt-1">Detailed financial breakdown</p>
            </button>

            <button onclick="generateReport('customer')" class="p-4 border-2 border-white/10 rounded-lg hover:border-blue-500/50 hover:bg-white/5 transition-all text-left">
                <i class="bi bi-people text-blue-400 text-2xl mb-2"></i>
                <h4 class="font-bold text-white">Customer Insights</h4>
                <p class="text-sm text-gray-400 mt-1">Customer behavior and trends</p>
            </button>

            <button onclick="generateReport('game')" class="p-4 border-2 border-white/10 rounded-lg hover:border-red-500/50 hover:bg-white/5 transition-all text-left">
                <i class="bi bi-controller text-red-400 text-2xl mb-2"></i>
                <h4 class="font-bold text-white">Game Performance</h4>
                <p class="text-sm text-gray-400 mt-1">Game utilization and revenue</p>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Booking Trend Chart
        const bookingTrendCtx = document.getElementById('bookingTrendChart');
        if (!bookingTrendCtx) return;
        
        const bookingsDataRaw = '{{ bookings_trend|escapejs }}';
        const bookingsData = JSON.parse(bookingsDataRaw.replace(/'/g, '"'));
        
        const bookingLabels = bookingsData.map(item => {
            const date = new Date(item.date);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });
        
        const bookingCounts = bookingsData.map(item => item.count);
        
        new Chart(bookingTrendCtx, {
            type: 'bar',
            data: {
                labels: bookingLabels,
                datasets: [{
                    label: 'Bookings',
                    data: bookingCounts,
                    backgroundColor: 'rgba(102, 126, 234, 0.8)',
                    borderColor: 'rgb(102, 126, 234)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                resizeDelay: 200,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        color: 'rgba(255, 255, 255, 0.7)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    });

        // Peak Hours Chart
        const peakHoursCtx = document.getElementById('peakHoursChart');
        if (!peakHoursCtx) return;
        
        const peakHoursDataRaw = '{{ peak_hours|escapejs }}';
        const peakHoursData = JSON.parse(peakHoursDataRaw.replace(/'/g, '"'));
        
        const hourLabels = peakHoursData.map(item => {
            const date = new Date(item.hour);
            return date.getHours() + ':00';
        });
        
        const hourCounts = peakHoursData.map(item => item.count);
        
        new Chart(peakHoursCtx, {
            type: 'line',
            data: {
                labels: hourLabels,
                datasets: [{
                    label: 'Bookings',
                    data: hourCounts,
                    borderColor: 'rgb(16, 185, 129)',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                resizeDelay: 200,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        color: 'rgba(255, 255, 255, 0.7)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        });
    });

    function generateReport(type) {
        alert(`Generating ${type} report... This feature will be fully implemented soon!`);
    }

    function exportReport() {
        alert('Export functionality coming soon! You will be able to export to Excel, PDF, and CSV formats.');
    }
</script>
{% endblock %}
