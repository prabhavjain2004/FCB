{% extends 'authentication/owner_base.html' %}
{% load static %}

{% block title %}Game Management Dashboard{% endblock %}
{% block page_title %}Game Management{% endblock %}
{% block page_subtitle %}Manage your games, schedules, and bookings{% endblock %}

{% block extra_css %}
<style>
    .hero-bg {
        position: absolute;
        inset: 0;
        overflow: hidden;
        z-index: 0;
        pointer-events: none;
    }
    
    .gradient-orb {
        position: absolute;
        border-radius: 50%;
        filter: blur(100px);
        opacity: 0.2;
        animation: floatOrb 20s ease-in-out infinite;
    }
    
    .orb-1 {
        width: 400px;
        height: 400px;
        background: radial-gradient(circle, rgba(102, 126, 234, 0.4) 0%, transparent 70%);
        top: -100px;
        right: -100px;
    }
    
    .orb-2 {
        width: 350px;
        height: 350px;
        background: radial-gradient(circle, rgba(168, 85, 247, 0.3) 0%, transparent 70%);
        bottom: -80px;
        left: -80px;
        animation-delay: 7s;
    }
    
    @keyframes floatOrb {
        0%, 100% { transform: translate(0, 0) scale(1); }
        33% { transform: translate(20px, -20px) scale(1.05); }
        66% { transform: translate(-20px, 20px) scale(0.95); }
    }
    
    .grid-pattern {
        background-image: 
            linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
        background-size: 50px 50px;
        position: absolute;
        inset: 0;
        z-index: 0;
    }
    
    .game-card {
        background: rgba(30, 41, 59, 0.5);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 1.5rem;
        padding: 1.5rem;
        transition: all 0.3s ease;
    }
    
    .game-card:hover {
        transform: translateY(-4px);
        border-color: rgba(102, 126, 234, 0.5);
    }
    
    @media (max-width: 768px) {
        .orb-1, .orb-2 {
            width: 250px;
            height: 250px;
            filter: blur(60px);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="relative">
    <!-- Background Elements -->
    <div class="hero-bg">
        <div class="gradient-orb orb-1"></div>
        <div class="gradient-orb orb-2"></div>
        <div class="grid-pattern"></div>
    </div>
    
    <!-- Quick Actions -->
    <div class="flex flex-wrap gap-3 mb-6 relative z-10 animate-fade-in-up">
        <a href="{% url 'booking:game_management:game_create' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Add New Game
        </a>
        <a href="{% url 'booking:game_management:custom_slot_create' %}" class="btn btn-secondary" style="background: rgba(16, 185, 129, 0.2); color: #34d399; border-color: rgba(16, 185, 129, 0.3);">
            <i class="bi bi-calendar-plus"></i> Add Custom Slot
        </a>
        <a href="{% url 'booking:game_management:schedule_management' %}" class="btn btn-secondary">
            <i class="bi bi-calendar-range"></i> Manage Schedules
        </a>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 relative z-10">
        <div class="stat-card animate-fade-in-up" style="animation-delay: 0.1s;">
            <div class="flex items-center justify-between mb-3">
                <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                    <i class="bi bi-controller text-white text-xl"></i>
                </div>
            </div>
            <p class="text-gray-400 text-xs mb-1 font-medium">Total Games</p>
            <h3 class="text-white text-2xl sm:text-3xl font-black" style="font-family: 'Orbitron', sans-serif;">{{ total_games }}</h3>
        </div>

        <div class="stat-card animate-fade-in-up" style="animation-delay: 0.2s;">
            <div class="flex items-center justify-between mb-3">
                <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: linear-gradient(135deg, #10b981, #059669);">
                    <i class="bi bi-check-circle text-white text-xl"></i>
                </div>
            </div>
            <p class="text-gray-400 text-xs mb-1 font-medium">Active Games</p>
            <h3 class="text-white text-2xl sm:text-3xl font-black" style="font-family: 'Orbitron', sans-serif;">{{ active_games }}</h3>
        </div>

        <div class="stat-card animate-fade-in-up" style="animation-delay: 0.3s;">
            <div class="flex items-center justify-between mb-3">
                <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                    <i class="bi bi-calendar-check text-white text-xl"></i>
                </div>
            </div>
            <p class="text-gray-400 text-xs mb-1 font-medium">Today's Bookings</p>
            <h3 class="text-white text-2xl sm:text-3xl font-black" style="font-family: 'Orbitron', sans-serif;">{{ today_bookings_count }}</h3>
        </div>

        <div class="stat-card animate-fade-in-up" style="animation-delay: 0.4s;">
            <div class="flex items-center justify-between mb-3">
                <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: linear-gradient(135deg, #a855f7, #9333ea);">
                    <i class="bi bi-currency-rupee text-white text-xl"></i>
                </div>
            </div>
            <p class="text-gray-400 text-xs mb-1 font-medium">Today's Revenue</p>
            <h3 class="text-white text-2xl sm:text-3xl font-black" style="font-family: 'Orbitron', sans-serif;">‚Çπ{{ today_revenue|floatformat:0 }}</h3>
        </div>
    </div>

    <!-- Games Grid -->
    {% if games %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8 relative z-10">
        {% for game in games %}
        <div class="game-card animate-fade-in-up" style="animation-delay: 0.{{ forloop.counter }}s;">
            <div class="flex justify-between items-start mb-4">
                <div class="flex-1">
                    <h3 class="text-xl font-black text-white mb-2">{{ game.name }}</h3>
                    <p class="text-gray-400 text-sm mb-3">{{ game.description|truncatechars:100 }}</p>
                </div>
                {% if game.image %}
                <img src="{{ game.image.url }}" alt="{{ game.name }}" class="w-16 h-16 object-cover rounded-lg ml-4">
                {% endif %}
            </div>

            <!-- Game Details -->
            <div class="space-y-2 mb-4">
                <div class="flex justify-between items-center text-sm">
                    <span class="text-gray-400">Capacity:</span>
                    <span class="text-white font-semibold">{{ game.capacity }} players</span>
                </div>
                <div class="flex justify-between items-center text-sm">
                    <span class="text-gray-400">Type:</span>
                    <span class="px-2 py-1 text-xs font-bold rounded-full {% if game.booking_type == 'SINGLE' %}bg-blue-500/20 text-blue-400 border border-blue-500/30{% else %}bg-purple-500/20 text-purple-400 border border-purple-500/30{% endif %}">
                        {% if game.booking_type == 'SINGLE' %}üîí Private{% else %}ü§ù Hybrid{% endif %}
                    </span>
                </div>
                <div class="flex justify-between items-center text-sm">
                    <span class="text-gray-400">Schedule:</span>
                    <span class="text-white font-semibold">{{ game.opening_time|time:'H:i' }} - {{ game.closing_time|time:'H:i' }}</span>
                </div>
                <div class="flex justify-between items-center text-sm">
                    <span class="text-gray-400">Private Price:</span>
                    <span class="text-green-400 font-bold">‚Çπ{{ game.private_price }}</span>
                </div>
                {% if game.shared_price %}
                <div class="flex justify-between items-center text-sm">
                    <span class="text-gray-400">Shared Price:</span>
                    <span class="text-blue-400 font-bold">‚Çπ{{ game.shared_price }}/person</span>
                </div>
                {% endif %}
            </div>

            <!-- Statistics -->
            <div class="border-t border-white/10 pt-4 mb-4">
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div>
                        <div class="text-lg font-black text-blue-400">{{ game.total_slots }}</div>
                        <div class="text-xs text-gray-500">Total Slots</div>
                    </div>
                    <div>
                        <div class="text-lg font-black text-green-400">{{ game.confirmed_bookings }}</div>
                        <div class="text-xs text-gray-500">Bookings</div>
                    </div>
                </div>
            </div>

            <!-- Status and Actions -->
            <div class="flex justify-between items-center">
                <span class="px-2 py-1 text-xs font-bold rounded-full {% if game.is_active %}bg-green-500/20 text-green-400 border border-green-500/30{% else %}bg-red-500/20 text-red-400 border border-red-500/30{% endif %}">
                    {% if game.is_active %}‚úÖ Active{% else %}‚ùå Inactive{% endif %}
                </span>

                <div class="flex gap-2">
                    <a href="{% url 'booking:game_detail' game.id %}" class="text-blue-400 hover:text-blue-300 text-sm font-semibold">
                        <i class="bi bi-eye"></i>
                    </a>
                    <a href="{% url 'booking:game_management:game_update' game.id %}" class="text-indigo-400 hover:text-indigo-300 text-sm font-semibold">
                        <i class="bi bi-pencil"></i>
                    </a>
                    <button onclick="toggleGameStatus('{{ game.id }}', {{ game.is_active|yesno:'true,false' }})" class="text-gray-400 hover:text-gray-300 text-sm font-semibold">
                        <i class="bi bi-{% if game.is_active %}pause-circle{% else %}play-circle{% endif %}"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="owner-card text-center py-12 relative z-10 animate-fade-in-up">
        <i class="bi bi-controller text-gray-600 text-6xl mb-4"></i>
        <h3 class="text-white font-bold text-lg mb-2">No games yet</h3>
        <p class="text-gray-400 mb-6">Get started by creating your first game.</p>
        <a href="{% url 'booking:game_management:game_create' %}" class="btn btn-primary inline-flex items-center gap-2">
            <i class="bi bi-plus-circle"></i> Add New Game
        </a>
    </div>
    {% endif %}

    <!-- Upcoming Bookings -->
    {% if upcoming_bookings %}
    <div class="owner-card relative z-10 animate-fade-in-up" style="animation-delay: 0.9s;">
        <h2 class="text-xl font-bold text-white mb-6">Upcoming Bookings</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead>
                    <tr class="border-b border-white/10">
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-400 uppercase">Game</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-400 uppercase">Customer</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-400 uppercase">Date & Time</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-400 uppercase">Type</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-400 uppercase">Amount</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-400 uppercase">Status</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/5">
                    {% for booking in upcoming_bookings %}
                    <tr class="hover:bg-white/5 transition-colors">
                        <td class="px-4 py-4 text-sm font-medium text-white">{{ booking.game.name }}</td>
                        <td class="px-4 py-4 text-sm text-white">{{ booking.customer.user.get_full_name|default:booking.customer.user.username }}</td>
                        <td class="px-4 py-4">
                            <div class="text-sm text-white">{{ booking.game_slot.date }}</div>
                            <div class="text-xs text-gray-400">{{ booking.game_slot.start_time|time:'H:i' }} - {{ booking.game_slot.end_time|time:'H:i' }}</div>
                        </td>
                        <td class="px-4 py-4">
                            <span class="px-2 py-1 text-xs font-bold rounded-full {% if booking.booking_type == 'PRIVATE' %}bg-blue-500/20 text-blue-400 border border-blue-500/30{% else %}bg-purple-500/20 text-purple-400 border border-purple-500/30{% endif %}">
                                {{ booking.booking_type|title }} ({{ booking.spots_booked }})
                            </span>
                        </td>
                        <td class="px-4 py-4 text-sm font-bold text-green-400">‚Çπ{{ booking.total_amount }}</td>
                        <td class="px-4 py-4">
                            <span class="px-2 py-1 text-xs font-bold rounded-full {% if booking.status == 'CONFIRMED' %}bg-green-500/20 text-green-400 border border-green-500/30{% elif booking.status == 'PENDING' %}bg-yellow-500/20 text-yellow-400 border border-yellow-500/30{% else %}bg-gray-500/20 text-gray-400 border border-gray-500/30{% endif %}">
                                {{ booking.get_status_display }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleGameStatus(gameId, isActive) {
    const action = isActive ? 'deactivate' : 'activate';
    
    if (confirm(`Are you sure you want to ${action} this game?`)) {
        fetch(`/booking/games/${gameId}/toggle-status/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('An error occurred while updating the game status.');
        });
    }
}
</script>
{% endblock %}
